<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Win Exploit Detection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-alt: #020617;
      --border: #1f2937;
      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.12);
      --accent-strong: rgba(249, 115, 22, 0.22);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.16);
      --ok: #22c55e;
      --ok-soft: rgba(34, 197, 94, 0.12);
      --warn: #eab308;
      --warn-soft: rgba(234, 179, 8, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #1e293b 0, #020617 45%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      max-width: 520px;
    }

    .upload-card {
      background: linear-gradient(135deg, var(--panel-alt), var(--panel));
      border-radius: 16px;
      padding: 18px 18px 14px;
      border: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 18px;
    }

    .upload-info {
      font-size: 13px;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
      border: 1px solid var(--accent-strong);
    }

    .upload-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .file-label {
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.15s, border-color 0.15s, transform 0.05s;
    }

    .file-label:hover {
      background: var(--accent-strong);
    }

    .file-label:active {
      transform: scale(0.98);
    }

    .file-input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .filename {
      font-size: 12px;
      color: var(--text-muted);
      max-width: 260px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-bottom: 18px;
    }

    .card {
      background: var(--panel);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 12px 12px 10px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .pill.danger {
      border-color: var(--danger);
      background: var(--danger-soft);
      color: var(--danger);
    }

    .pill.warn {
      border-color: var(--warn);
      background: var(--warn-soft);
      color: var(--warn);
    }

    .pill.ok {
      border-color: var(--ok);
      background: var(--ok-soft);
      color: var(--ok);
    }

    .metric-number {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .metric-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .metric-detail {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .section {
      margin-top: 18px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .section-note {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .filter-label {
      color: var(--text-muted);
      font-size: 10px;
    }

    .filter-input,
    .filter-select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 8px;
      color: var(--text-main);
      font-size: 11px;
      min-width: 90px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: var(--panel);
    }

    thead {
      background: #020617;
    }

    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      font-weight: 500;
      color: var(--text-muted);
    }

    tbody tr:nth-child(even) {
      background: #020617;
    }

    .severity {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      display: inline-block;
    }

    .severity.high {
      background: var(--danger-soft);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.7);
    }

    .severity.medium {
      background: var(--warn-soft);
      color: var(--warn);
      border: 1px solid rgba(234, 179, 8, 0.7);
    }

    .severity.low {
      background: var(--ok-soft);
      color: var(--ok);
      border: 1px solid rgba(34, 197, 94, 0.7);
    }

    .empty {
      font-size: 12px;
      color: var(--text-muted);
      padding: 8px 0;
    }

    .system-meta {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .system-meta span {
      color: var(--text-main);
    }

    .btn {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
      cursor: pointer;
      margin-right: 4px;
    }

    .btn-secondary {
      border-color: var(--border);
      background: #020617;
      color: var(--text-muted);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal {
      background: var(--panel);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 14px 16px;
      max-width: 440px;
      width: 100%;
      font-size: 12px;
    }

    .modal-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .modal-body {
      color: var(--text-muted);
      white-space: pre-wrap;
      margin-bottom: 8px;
    }

    .modal-footer {
      text-align: right;
    }

    @media (max-width: 640px) {
      .title {
        font-size: 20px;
      }
      .upload-card {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
	  <div class="title-block">
		<div class="badge">Win-Exploit Detection</div>
		<div class="title">Windows Exploit Scanner</div>
		<div class="subtitle">
		  Follow the steps below to scan your Windows system for common privilege-escalation
		  and persistence entry points.
		  <br><br>
		  <strong>Step 1:</strong> Download the Win-ED scanner from GitHub:<br>
		  <a href="https://github.com/swadekiri/Win-ED" 
			 target="_blank" 
			 style="color: var(--accent); text-decoration: underline;">
			https://github.com/swadekiri/Win-ED
		  </a>
		  <br><br>
		  <strong>Step 2:</strong> Run <code>win_ed.exe</code> on the Windows host.<br>
		  It will automatically generate a JSON report inside:<br>
		  <code>C:\ProgramData\WinExploitScan\</code>
		  <br><br>
		  <strong>Step 3:</strong> Upload that JSON file below to analyze potential exploit
		  entry points. This webpage runs fully offline inside your browser.
		  <b>Step 4:</b> Before using any <i>Fix</i> button in the dashboard, run:<br>
		  <code>win_ed_helper.exe</code><br>
		  (also available in the GitHub repository).<br>
		  This helper must stay running with Administrator privileges.  
		  It provides a secure local API at <code>http://127.0.0.1:9910/</code> that allows
		  Win-ED to safely apply fixes such as quoting unquoted service paths.
		  <br><br>

		  <b>Step 5:</b> After the helper is running, you may click <b>Fix</b> next to any service
		  in the dashboard to automatically apply the recommended correction.
		  <br><br>

		  <b style="color: var(--warn);">NOTE:</b>  
		  Some findings shown in the dashboard are <b>not exploitable</b> in real-world conditions.
		  For example, if a service is located in a protected Windows directory or the path is
		  inside a non-writable location, the risk may be theoretical only.  
		  Use the severity rating and explanations to determine whether action is required.
		</div>
	  </div>
	</header>

<div class="upload-card">
  <div>
    <div class="upload-info">
      Select the JSON scan report generated by Win-ED.<br>
      The file is typically located in:<br>
      <code>C:\ProgramData\WinExploitScan\</code>
    </div>
  </div>
  <div class="upload-controls">
    <label class="file-label">
      <span>Select JSON report</span>
      <input id="fileInput" class="file-input" type="file" accept=".json,application/json" />
    </label>
    <div id="filename" class="filename"></div>
  </div>
</div>

    <div id="content" style="display:none;">
      <div class="grid">
        <div class="card">
          <div class="card-header">
            <div class="card-title">System</div>
          </div>
          <div class="system-meta" id="systemMeta"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Unquoted service paths</div>
            <div id="pillUnquoted" class="pill">No data</div>
          </div>
          <div class="metric-number" id="countUnquoted">0</div>
          <div class="metric-label">Services with unquoted paths</div>
          <div class="metric-detail">
            These are classic privilege escalation risks. Service paths containing spaces should be quoted.
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Services in user writable paths</div>
            <div id="pillUserWritableSvc" class="pill">No data</div>
          </div>
          <div class="metric-number" id="countUserWritableSvc">0</div>
          <div class="metric-label">Service binaries located in user writable folders</div>
          <div class="metric-detail">
            If an attacker can modify the service binary path, they can gain elevated execution.
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Startup in user writable paths</div>
            <div id="pillStartup" class="pill">No data</div>
          </div>
          <div class="metric-number" id="countStartup">0</div>
          <div class="metric-label">Startup entries from user writable locations</div>
          <div class="metric-detail">
            Review these for persistence or unwanted autoruns.
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Remote access and firewall</div>
            <div id="pillRemote" class="pill">No data</div>
          </div>
          <div class="metric-number" id="rdpStatusLabel">Unknown</div>
          <div class="metric-label" id="fwSummary">Firewall profile summary unavailable</div>
          <div class="metric-detail">
            Exposed RDP or disabled firewall profiles can increase the attack surface.
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Local Administrators</div>
          </div>
          <div class="metric-number" id="countAdmins">0</div>
          <div class="metric-label">Members of the local Administrators group</div>
          <div class="metric-detail">
            Limit membership to accounts that truly require full administrative privileges.
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Unquoted service paths</div>
        <div class="section-note">
          Services listed here have unquoted ImagePath values with spaces. Fix by quoting the full path in the service configuration and testing service startup carefully.
        </div>

        <div class="filter-bar" id="unquotedFilterBar">
          <div class="filter-group">
            <span class="filter-label">Severity</span>
            <select id="filterSeverity" class="filter-select">
              <option value="all">All</option>
              <option value="high" selected>High only</option>
            </select>
          </div>
          <div class="filter-group">
            <span class="filter-label">ServiceName</span>
            <input id="filterServiceName" class="filter-input" list="serviceNameList" placeholder="Contains..." />
          </div>
          <div class="filter-group">
            <span class="filter-label">DisplayName</span>
            <input id="filterDisplayName" class="filter-input" list="displayNameList" placeholder="Contains..." />
          </div>
          <div class="filter-group">
            <span class="filter-label">PathName</span>
            <input id="filterPathName" class="filter-input" list="pathNameList" placeholder="Contains..." />
          </div>
          <div class="filter-group">
            <span class="filter-label">StartName</span>
            <input id="filterStartName" class="filter-input" list="startNameList" placeholder="Contains..." />
          </div>
          <div class="filter-group">
            <span class="filter-label">State</span>
            <select id="filterState" class="filter-select">
              <option value="">Any</option>
            </select>
          </div>
          <div class="filter-group">
            <span class="filter-label">StartMode</span>
            <select id="filterStartMode" class="filter-select">
              <option value="">Any</option>
            </select>
          </div>
        </div>

        <datalist id="serviceNameList"></datalist>
        <datalist id="displayNameList"></datalist>
        <datalist id="pathNameList"></datalist>
        <datalist id="startNameList"></datalist>

        <div id="tableUnquoted"></div>
      </div>

      <div class="section">
        <div class="section-title">Services in user writable locations</div>
        <div class="section-note">
          Service binaries in user-writable paths should be moved to secure locations such as Program Files and reconfigured.
        </div>
        <div id="tableUserWritableSvc"></div>
      </div>

      <div class="section">
        <div class="section-title">Startup items in user writable locations</div>
        <div class="section-note">
          Review these entries for persistence mechanisms and unwanted software.
        </div>
        <div id="tableStartup"></div>
      </div>

      <div class="section">
        <div class="section-title">Firewall profiles</div>
        <div class="section-note">
          All profiles should normally be enabled, with restrictive inbound rules.
        </div>
        <div id="tableFirewall"></div>
      </div>

      <div class="section">
        <div class="section-title">Local Administrators group</div>
        <div id="tableAdmins"></div>
      </div>

      <div class="section">
        <div class="section-title">Installed applications (summary)</div>
        <div class="section-note">
          This is a basic view from the Uninstall registry keys. Use it to spot unexpected or legacy software.
        </div>
        <div id="tableApps"></div>
      </div>
    </div>
  </div>

  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div id="modalTitle" class="modal-title"></div>
      <div id="modalBody" class="modal-body"></div>
      <div class="modal-footer">
        <button id="modalClose" class="btn btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const filenameEl = document.getElementById("filename");
    const contentEl = document.getElementById("content");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const modalTitleEl = document.getElementById("modalTitle");
    const modalBodyEl = document.getElementById("modalBody");
    const modalCloseBtn = document.getElementById("modalClose");

    let unquotedOriginal = [];
    let servicesWritable = [];
    let startupWritable = [];

    modalCloseBtn.addEventListener("click", () => hideModal());
    modalBackdrop.addEventListener("click", e => {
      if (e.target === modalBackdrop) hideModal();
    });

    function showModal(title, body) {
      modalTitleEl.textContent = title;
      modalBodyEl.textContent = body;
      modalBackdrop.style.display = "flex";
    }

    function hideModal() {
      modalBackdrop.style.display = "none";
    }

    fileInput.addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;

      filenameEl.textContent = file.name;

      const reader = new FileReader();
      reader.onload = function (evt) {
        try {
          const text = evt.target.result;
          const data = JSON.parse(text);
          populateDashboard(data);
          contentEl.style.display = "block";
        } catch (err) {
          alert("Could not parse JSON. Make sure you selected the output from WinExploitScan.ps1.");
          console.error(err);
        }
      };
      reader.readAsText(file, "utf-8");
    });

    function getFindings(data) {
      return data.findings || data.riskFindings || {};
    }

    function populateDashboard(data) {
      const findings = getFindings(data);

      const unquoted = findings.unquotedServicePaths || [];
      const svcsWritable = findings.servicesInUserWritable || [];
      const startup = findings.startupInUserWritable || [];
      const rdpStatus = findings.rdpStatus || null;
      const firewallProfiles = findings.firewallProfiles || [];
      const localAdmins = findings.localAdmins || [];
      const installedApps = findings.installedApps || [];

      unquotedOriginal = unquoted;
      servicesWritable = svcsWritable;
      startupWritable = startup;

      renderSystemMeta(data);

      setMetric("countUnquoted", "pillUnquoted", unquoted.length, "high");
      setMetric("countUserWritableSvc", "pillUserWritableSvc", svcsWritable.length, "high");
      setMetric("countStartup", "pillStartup", startup.length, "medium");
      setAdminsMetric("countAdmins", localAdmins);
      setRemoteMetric("rdpStatusLabel", "fwSummary", "pillRemote", rdpStatus, firewallProfiles);

      setupUnquotedFilters(unquoted);
      applyUnquotedFilters();

      renderTable(
        "tableUserWritableSvc",
        svcsWritable,
        ["ServiceName", "DisplayName", "PathName", "StartName", "State", "StartMode"],
        { severity: "high" }
      );

      renderTable(
        "tableStartup",
        startup,
        ["Source", "Name", "Command"],
        { severity: "medium" }
      );

      renderFirewallTable("tableFirewall", firewallProfiles);
      renderAdminsTable("tableAdmins", localAdmins);
      renderAppsTable("tableApps", installedApps);
    }

    function renderSystemMeta(data) {
      const el = document.getElementById("systemMeta");
      const sys = data.systemInfo || {};
      const os = sys.os || {};
      const cs = sys.computer || {};
      const bios = sys.bios || {};

      const lines = [];
      lines.push("Host: <span>" + (data.computerName || "Unknown") + "</span>");
      lines.push("User: <span>" + (data.userName || "Unknown") + "</span>");
      lines.push("Generated: <span>" + (data.generatedAt || "Unknown") + "</span>");

      if (os.Caption) {
        lines.push("OS: <span>" + os.Caption + " (Version " + (os.Version || "n/a") + ", Build " + (os.BuildNumber || "n/a") + ")</span>");
      }

      if (cs.Manufacturer || cs.Model) {
        lines.push("Hardware: <span>" + (cs.Manufacturer || "Unknown") + " " + (cs.Model || "") + "</span>");
      }

      if (bios.Manufacturer || bios.SMBIOSBIOSVersion) {
        lines.push("BIOS: <span>" + (bios.Manufacturer || "Unknown") + " " + (bios.SMBIOSBIOSVersion || "") + "</span>");
      }

      el.innerHTML = lines.join("<br />");
    }

    function setMetric(numberId, pillId, count, severity) {
      document.getElementById(numberId).textContent = count;

      const pill = document.getElementById(pillId);
      pill.classList.remove("danger", "warn", "ok");

      if (count === 0) {
        pill.textContent = "Clean";
        pill.classList.add("ok");
      } else {
        if (severity === "high") {
          pill.textContent = "Attention required";
          pill.classList.add("danger");
        } else if (severity === "medium") {
          pill.textContent = "Review recommended";
          pill.classList.add("warn");
        } else {
          pill.textContent = "Review";
        }
      }
    }

    function setAdminsMetric(numberId, admins) {
      const count = admins.length || 0;
      document.getElementById(numberId).textContent = count;
    }

    function setRemoteMetric(labelId, fwSummaryId, pillId, rdpStatus, firewallProfiles) {
      const labelEl = document.getElementById(labelId);
      const fwEl = document.getElementById(fwSummaryId);
      const pill = document.getElementById(pillId);
      pill.classList.remove("danger", "warn", "ok");

      if (rdpStatus && typeof rdpStatus.RdpEnabled === "boolean") {
        if (rdpStatus.RdpEnabled) {
          labelEl.textContent = "RDP enabled";
          pill.textContent = "Surface increased";
          pill.classList.add("warn");
        } else {
          labelEl.textContent = "RDP disabled";
          pill.textContent = "Surface reduced";
          pill.classList.add("ok");
        }
      } else {
        labelEl.textContent = "RDP status unknown";
        pill.textContent = "Unknown";
      }

      if (firewallProfiles && firewallProfiles.length > 0) {
        let enabled = 0;
        let disabled = 0;
        firewallProfiles.forEach(p => {
          if (p.Enabled) enabled++; else disabled++;
        });
        fwEl.textContent = "Firewall profiles enabled: " + enabled + ", disabled: " + disabled;
      } else {
        fwEl.textContent = "Firewall profile data not present in report.";
      }
    }

    function renderTable(containerId, items, columns, options) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      if (!items || items.length === 0) {
        const div = document.createElement("div");
        div.className = "empty";
        div.textContent = "No entries in this category.";
        container.appendChild(div);
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const trHead = document.createElement("tr");

      if (options && options.severity) {
        const th = document.createElement("th");
        th.textContent = "Severity";
        trHead.appendChild(th);
      }

      columns.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        trHead.appendChild(th);
      });

      thead.appendChild(trHead);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      items.forEach(item => {
        const tr = document.createElement("tr");

        if (options && options.severity) {
          const td = document.createElement("td");
          const sevSpan = document.createElement("span");
          const sevClass =
            options.severity === "high"
              ? "high"
              : options.severity === "medium"
              ? "medium"
              : "low";
          sevSpan.className = "severity " + sevClass;
          sevSpan.textContent =
            options.severity === "high"
              ? "High"
              : options.severity === "medium"
              ? "Medium"
              : "Low";
          td.appendChild(sevSpan);
          tr.appendChild(td);
        }

        columns.forEach(col => {
          const td = document.createElement("td");
          const val = item[col];
          td.textContent = val === undefined || val === null ? "" : String(val);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }

    function renderFirewallTable(containerId, profiles) {
      const columns = ["Name", "Enabled", "DefaultInboundAction", "DefaultOutboundAction"];
      renderTable(containerId, profiles || [], columns, null);
    }

    function renderAdminsTable(containerId, admins) {
      const columns = ["Name", "AdsPath"];
      renderTable(containerId, admins || [], columns, { severity: "medium" });
    }

    function renderAppsTable(containerId, apps) {
      const maxApps = 80;
      const subset = (apps || []).slice(0, maxApps);
      const columns = ["DisplayName", "DisplayVersion", "Publisher", "InstallDate"];
      renderTable(containerId, subset, columns, null);
    }

    function populateDatalist(id, values) {
      const el = document.getElementById(id);
      if (!el) return;
      el.innerHTML = "";
      const seen = new Set();
      (values || []).forEach(v => {
        if (!v) return;
        const s = String(v);
        if (seen.has(s)) return;
        seen.add(s);
        const opt = document.createElement("option");
        opt.value = s;
        el.appendChild(opt);
      });
    }

    function setupUnquotedFilters(unquoted) {
      const states = new Set();
      const startModes = new Set();

      unquoted.forEach(it => {
        if (it.State) states.add(String(it.State));
        if (it.StartMode) startModes.add(String(it.StartMode));
      });

      const stateSel = document.getElementById("filterState");
      const startSel = document.getElementById("filterStartMode");

      stateSel.innerHTML = '<option value="">Any</option>';
      startSel.innerHTML = '<option value="">Any</option>';

      Array.from(states).sort().forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        stateSel.appendChild(opt);
      });

      Array.from(startModes).sort().forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        startSel.appendChild(opt);
      });

      populateDatalist("serviceNameList", unquoted.map(i => i.ServiceName));
      populateDatalist("displayNameList", unquoted.map(i => i.DisplayName));
      populateDatalist("pathNameList", unquoted.map(i => i.PathName));
      populateDatalist("startNameList", unquoted.map(i => i.StartName));

      document.getElementById("filterSeverity").onchange = applyUnquotedFilters;
      document.getElementById("filterServiceName").oninput = applyUnquotedFilters;
      document.getElementById("filterDisplayName").oninput = applyUnquotedFilters;
      document.getElementById("filterPathName").oninput = applyUnquotedFilters;
      document.getElementById("filterStartName").oninput = applyUnquotedFilters;
      document.getElementById("filterState").onchange = applyUnquotedFilters;
      document.getElementById("filterStartMode").onchange = applyUnquotedFilters;
    }

    function applyUnquotedFilters() {
      const sevFilter = document.getElementById("filterSeverity").value;
      const svcFilter = document.getElementById("filterServiceName").value.trim().toLowerCase();
      const dispFilter = document.getElementById("filterDisplayName").value.trim().toLowerCase();
      const pathFilter = document.getElementById("filterPathName").value.trim().toLowerCase();
      const startNameFilter = document.getElementById("filterStartName").value.trim().toLowerCase();
      const stateFilter = document.getElementById("filterState").value;
      const startModeFilter = document.getElementById("filterStartMode").value;

      const filtered = (unquotedOriginal || []).filter(item => {
        if (sevFilter === "high") {
          // all unquoted paths are high severity, nothing special to do
        }

        if (svcFilter && (!(item.ServiceName || "").toLowerCase().includes(svcFilter))) return false;
        if (dispFilter && (!(item.DisplayName || "").toLowerCase().includes(dispFilter))) return false;
        if (pathFilter && (!(item.PathName || "").toLowerCase().includes(pathFilter))) return false;
        if (startNameFilter && (!(item.StartName || "").toLowerCase().includes(startNameFilter))) return false;
        if (stateFilter && String(item.State) !== stateFilter) return false;
        if (startModeFilter && String(item.StartMode) !== startModeFilter) return false;
        return true;
      });

      renderUnquotedTable(filtered);
    }

    function renderUnquotedTable(items) {
      const container = document.getElementById("tableUnquoted");
      container.innerHTML = "";

      if (!items || items.length === 0) {
        const div = document.createElement("div");
        div.className = "empty";
        div.textContent = "No unquoted service paths match the current filters.";
        container.appendChild(div);
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const trHead = document.createElement("tr");

      const headers = ["Severity", "ServiceName", "DisplayName", "PathName", "StartName", "State", "StartMode", "Actions"];
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        trHead.appendChild(th);
      });

      thead.appendChild(trHead);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      items.forEach(item => {
        const tr = document.createElement("tr");

        const tdSev = document.createElement("td");
        const sevSpan = document.createElement("span");
        sevSpan.className = "severity high";
        sevSpan.textContent = "High";
        tdSev.appendChild(sevSpan);
        tr.appendChild(tdSev);

        function addCell(val) {
          const td = document.createElement("td");
          td.textContent = val === undefined || val === null ? "" : String(val);
          tr.appendChild(td);
        }

        addCell(item.ServiceName);
        addCell(item.DisplayName);
        addCell(item.PathName);
        addCell(item.StartName);
        addCell(item.State);
        addCell(item.StartMode);

        const tdActions = document.createElement("td");

        const fixBtn = document.createElement("button");
        fixBtn.className = "btn";
        fixBtn.textContent = "Fix";
        fixBtn.onclick = () => attemptFixUnquoted(item, fixBtn);
        tdActions.appendChild(fixBtn);

        const infoBtn = document.createElement("button");
        infoBtn.className = "btn btn-secondary";
        infoBtn.textContent = "Explain";
        infoBtn.onclick = () => showUnquotedExplanation(item);
        tdActions.appendChild(infoBtn);

        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }

    function showUnquotedExplanation(item) {
      const svc = item.ServiceName || "(unknown)";
      const path = item.PathName || "(no path recorded)";

      const text =
        "Issue: Unquoted service path\n\n" +
        "Service: " + svc + "\n" +
        "Current PathName:\n" + path + "\n\n" +
        "Why this is dangerous:\n" +
        "- The service ImagePath contains spaces but is not quoted.\n" +
        "- Windows may search for executables at each space boundary.\n" +
        "- An attacker with write access could place a malicious executable earlier in the path (for example C:\\Program.exe) " +
        "and have it run with the service account (often LocalSystem).\n\n" +
        "How the automatic fix works:\n" +
        "- It finds the .exe portion of the PathName.\n" +
        "- It wraps the executable path in quotes.\n" +
        "- Any arguments remain outside the quotes.\n" +
        "- It runs: sc.exe config <ServiceName> \"binPath= \"QuotedPath\" args\" and attempts to restart the service.\n\n" +
        "You should test the service after the fix to ensure it still starts correctly.";

      showModal("Unquoted service path: " + svc, text);
    }

    function attemptFixUnquoted(item, button) {
      const svc = item.ServiceName;
      if (!svc) {
        alert("ServiceName is missing for this entry.");
        return;
      }

      const ok = confirm(
        "Do you want to automatically fix the unquoted service path for:\n\n" +
        "ServiceName: " + svc + "\n\n" +
        "This will call the local WinExploitHelper on this machine and run sc.exe config."
      );
      if (!ok) return;

      button.disabled = true;

      fetch("http://127.0.0.1:9910/fix", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "fix_unquoted_service",
          serviceName: svc
        })
      })
        .then(r => r.json())
        .then(resp => {
          button.disabled = false;
          const msg =
            "Result from WinExploitHelper:\n\n" +
            "success: " + resp.success + "\n" +
            "message: " + (resp.message || "");
          alert(msg);
        })
        .catch(err => {
          button.disabled = false;
          alert(
            "Could not reach WinExploitHelper on http://127.0.0.1:9910.\n\n" +
            "Make sure WinExploitHelper.ps1 (or its EXE) is running as Administrator on this machine.\n\n" +
            "Error: " + err
          );
        });
    }
  </script>
</body>
</html>
